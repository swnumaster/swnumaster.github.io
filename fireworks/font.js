const nathanfonts = {
    StrightThick: {
        pointWidthBase: 1,
        pointHeightBase: 1,
        pointRows: 5,
        fontLetters: {
            SPACE: {
                cols: 1,
                matrix: []  // all zeros
            },
            EXCLAIMATION: {
                cols: 1,
                matrix: [
                    [1],
                    [1],
                    [1],
                    [0],
                    [1]
                ]
            },
            SHARP: {
                cols: 5,
                matrix: [
                    [0,1,0,1,0],
                    [1,1,1,1,1],
                    [0,1,0,1,0],
                    [1,1,1,1,1],
                    [0,1,0,1,0]
                ]
            },
            AT: {
                cols: 5,
                matrix: [
                    [1,1,1,1,1],
                    [0,0,0,0,1],
                    [1,1,1,0,1],
                    [1,0,1,0,1],
                    [1,1,1,1,1]
                ]
            },
            STAR: {
                cols: 1,
                matrix: [
                    [1],
                    [1],
                    [1],
                    [1],
                    [1]
                ]
            },
            HYPHEN: {
                cols: 1,
                matrix: [
                    [0],
                    [0],
                    [1],
                    [0],
                    [0]
                ]
            },
            ONE: {
                cols: 1,
                matrix: [
                    [1],
                    [1],
                    [1],
                    [1],
                    [1]
                ]
            },
            TWO: {
                cols: 4,
                matrix: [
                    [1,1,1,1],
                    [0,0,0,1],
                    [1,1,1,1],
                    [1,0,0,0],
                    [1,1,1,1]
                ]
            },
            THREE: {
                cols: 4,
                matrix: [
                    [1,1,1,1],
                    [0,0,0,1],
                    [1,1,1,1],
                    [0,0,0,1],
                    [1,1,1,1]
                ]
            },
            FOUR: {
                cols: 4,
                matrix: [
                    [1,0,0,1],
                    [1,0,0,1],
                    [1,1,1,1],
                    [0,0,0,1],
                    [0,0,0,1]
                ]
            },
            FIVE: {
                cols: 4,
                matrix: [
                    [1,1,1,1],
                    [1,0,0,0],
                    [1,1,1,1],
                    [0,0,0,1],
                    [1,1,1,1]
                ]
            },
            SIX: {
                cols: 4,
                matrix: [
                    [1,1,1,1],
                    [1,0,0,0],
                    [1,1,1,1],
                    [1,0,0,1],
                    [1,1,1,1]
                ]
            },
            SEVEN: {
                cols: 4,
                matrix: [
                    [1,1,1,1],
                    [0,0,0,1],
                    [0,0,0,1],
                    [0,0,0,1],
                    [0,0,0,1]
                ]
            },
            EIGHT: {
                cols: 4,
                matrix: [
                    [1,1,1,1],
                    [1,0,0,1],
                    [1,1,1,1],
                    [1,0,0,1],
                    [1,1,1,1]
                ]
            },
            NINE: {
                cols: 4,
                matrix: [
                    [1,1,1,1],
                    [1,0,0,1],
                    [1,1,1,1],
                    [0,0,0,1],
                    [1,1,1,1]
                ]
            },
            ZERO: {
                cols: 4,
                matrix: [
                    [1,1,1,1],
                    [1,0,0,1],
                    [1,0,0,1],
                    [1,0,0,1],
                    [1,1,1,1]
                ]
            },
            A: {
                cols: 4,
                matrix: [
                    [1,1,1,1],
                    [1,0,0,1],
                    [1,1,1,1],
                    [1,0,0,1],
                    [1,0,0,1]
                ]
            },
            B: {
                cols: 4,
                matrix: [
                    [1,1,1,1],
                    [1,0,0,1],
                    [1,1,1,1],
                    [1,0,0,1],
                    [1,1,1,1]
                ]
            },
            C: {
                cols: 4,
                matrix: [
                    [1,1,1,1],
                    [1,0,0,0],
                    [1,0,0,0],
                    [1,0,0,0],
                    [1,1,1,1]
                ]
            },
            D: {
                cols: 4,
                matrix: [
                    [1,1,1,1],
                    [1,0,0,1],
                    [1,0,0,1],
                    [1,0,0,1],
                    [1,1,1,1]
                ]
            },
            E: {
                cols: 4,
                matrix: [
                    [1,1,1,1],
                    [1,0,0,0],
                    [1,1,1,1],
                    [1,0,0,0],
                    [1,1,1,1]
                ]
            },
            F: {
                cols: 4,
                matrix: [
                    [1,1,1,1],
                    [1,0,0,0],
                    [1,1,1,1],
                    [1,0,0,0],
                    [1,0,0,0]
                ]
            },
            G: {
                cols: 4,
                matrix: [
                    [1,1,1,1],
                    [1,0,0,0],
                    [1,0,1,1],
                    [1,0,0,1],
                    [1,1,1,1]
                ]
            },
            H: {
                cols: 4,
                matrix: [
                    [1,0,0,1],
                    [1,0,0,1],
                    [1,1,1,1],
                    [1,0,0,1],
                    [1,0,0,1]
                ]
            },
            I: {
                cols: 1,
                matrix: [
                    [1],
                    [1],
                    [1],
                    [1],
                    [1]
                ]
            },
            J: {
                cols: 3,
                matrix: [
                    [0,0,1],
                    [0,0,1],
                    [0,0,1],
                    [0,0,1],
                    [1,1,1]
                ]
            },
            K: {
                cols: 4,
                matrix: [
                    [1,0,0,1],
                    [1,0,1,0],
                    [1,1,0,0],
                    [1,0,1,0],
                    [1,0,0,1]
                ]
            },
            L: {
                cols: 4,
                matrix: [
                    [1,0,0,0],
                    [1,0,0,0],
                    [1,0,0,0],
                    [1,0,0,0],
                    [1,1,1,1]
                ]
            },
            M: {
                cols: 5,
                matrix: [
                    [1,0,0,0,1],
                    [1,1,0,1,1],
                    [1,0,1,0,1],
                    [1,0,0,0,1],
                    [1,0,0,0,1]
                ]
            },
            N: {
                cols: 5,
                matrix: [
                    [1,0,0,0,1],
                    [1,1,0,0,1],
                    [1,0,1,0,1],
                    [1,0,0,1,1],
                    [1,0,0,0,1]
                ]
            },
            O: {
                cols: 4,
                matrix: [
                    [1,1,1,1],
                    [1,0,0,1],
                    [1,0,0,1],
                    [1,0,0,1],
                    [1,1,1,1]
                ]
            },
            P: {
                cols: 4,
                matrix: [
                    [1,1,1,1],
                    [1,0,0,1],
                    [1,1,1,1],
                    [1,0,0,0],
                    [1,0,0,0]
                ]
            },
            Q: {
                cols: 5,
                matrix: [
                    [1,1,1,1],
                    [1,0,0,1],
                    [1,0,0,1],
                    [1,1,1,1],
                    [0,0,0,1]
                ]
            },
            R: {
                cols: 4,
                matrix: [
                    [1,1,1,1],
                    [1,0,0,1],
                    [1,1,1,1],
                    [1,0,1,0],
                    [1,0,0,1]
                ]
            },
            S: {
                cols: 4,
                matrix: [
                    [1,1,1,1],
                    [1,0,0,0],
                    [1,1,1,1],
                    [0,0,0,1],
                    [1,1,1,1]
                ]
            },
            T: {
                cols: 5,
                matrix: [
                    [1,1,1,1,1],
                    [0,0,1,0,0],
                    [0,0,1,0,0],
                    [0,0,1,0,0],
                    [0,0,1,0,0]
                ]
            },
            U: {
                cols: 4,
                matrix: [
                    [1,0,0,1],
                    [1,0,0,1],
                    [1,0,0,1],
                    [1,0,0,1],
                    [1,1,1,1]
                ]
            },
            V: {
                cols: 5,
                matrix: [
                    [1,0,0,0,1],
                    [1,0,0,0,1],
                    [1,0,0,0,1],
                    [0,1,0,1,0],
                    [0,0,1,0,0]
                ]
            },
            W: {
                cols: 5,
                matrix: [
                    [1,0,0,0,1],
                    [1,0,0,0,1],
                    [1,0,1,0,1],
                    [1,1,0,1,1],
                    [1,0,0,0,1]
                ]
            },
            X: {
                cols: 5,
                matrix: [
                    [1,0,0,0,1],
                    [0,1,0,1,0],
                    [0,0,1,0,0],
                    [0,1,0,1,0],
                    [1,0,0,0,1]
                ]
            },
            Y: {
                cols: 5,
                matrix: [
                    [1,0,0,0,1],
                    [1,0,0,0,1],
                    [1,1,1,1,1],
                    [0,0,1,0,0],
                    [0,0,1,0,0]
                ]
            },
            Z: {
                cols: 5,
                matrix: [
                    [1,1,1,1,1],
                    [0,0,0,1,0],
                    [0,0,1,0,0],
                    [0,1,0,0,0],
                    [1,1,1,1,1]
                ]
            }
        }
    }
};

function getFontPoints(text, x, y, w, h, fonSize = 20, fontName = "StrightThick") {
    const currentFont = nathanfonts[fontName];
    if (currentFont == undefined) return [];

    const pointWidth = currentFont.pointWidthBase * fonSize;
    const pointHeight = currentFont.pointHeightBase * fonSize;
    var totalWidth = 0;
    var totalHeight = 0;

    return getPoints(text, x, y, w, h);

    function getPoints(text, x, y, w, h) {
        var positions = [];
        var fontLetters = [];
        text = text.toUpperCase();
        // compute total width
        for (let i = 0; i < text.length; i ++) {
            let letter = convertLetter(text[i]);
            const fontLetter = currentFont.fontLetters[letter];
            if (fontLetter) {  // defined
                let width = getWidthOfLetter(fontLetter);
                if (w && (totalWidth + pointWidth + width) > w)
                    break;
                if (fontLetters.length == 0)
                    totalWidth = width;
                else
                    totalWidth += width + pointWidth;

                fontLetters.push(fontLetter);
            }
        }
        // comoute height
        totalHeight = getHeightOfLetter();
        w = w || totalWidth;
        h = h || totalHeight;

        // base x, y
        var baseX = (w - totalWidth) / 2 + pointWidth / 2;
        var baseY = Math.max((h - totalHeight) / 2, 0) + pointHeight / 2;
        zog(text, x, y, w, h, totalWidth, totalHeight, baseX, baseY);

        // compute positions
        for (let i = 0; i < fontLetters.length; i ++) {
            // zog(fontLetters[i], baseX, baseY);
            positions = positions.concat(getPositionsOfLetter(fontLetters[i], baseX, baseY));
            baseX += pointWidth + getWidthOfLetter(fontLetters[i]);
        }
        return {width: totalWidth, height: totalHeight, positions: positions};
    }

    function convertLetter(letter) {
        switch (letter) {
            case " ":
                return "SPACE";
            case "!":
                return "EXCLAIMATION";
            case "#":
                return "SHARP";
            case "@":
                return "AT";
            case "*":
                return "STAR";
            case "-":
                return "HYPHEN";
            case "1":
                return "ONE";
            case "2":
                return "TWO";
            case "3":
                return "THREE";
            case "4":
                return "FOUR";
            case "5":
                return "FIVE";
            case "6":
                return "SIX";
            case "7":
                return "SEVEN";
            case "8":
                return "EIGHT";
            case "9":
                return "NINE";
            case "0":
                return "ZERO";
        }
        return letter;
    }

    function getPositionsOfLetter(fontLetter, baseX, baseY) {
        var positions = [];
        if (fontLetter.matrix.length == 0) return positions;
        for (let row = 0; row < currentFont.pointRows; row ++) {
            for (let col = 0; col < fontLetter.cols; col ++) {
                if (fontLetter.matrix[row] && fontLetter.matrix[row][col] == 1) {
                    positions.push([
                        baseX + col * pointWidth,
                        baseY + row * pointHeight
                    ]);
                }
            }
        }
        return positions;
    }

    function getWidthOfLetter(fontLetter) {
        return pointWidth * fontLetter.cols;
    }

    function getHeightOfLetter() {
        return pointHeight * currentFont.pointRows;
    }
}

class NathanLabel extends Container {
    constructor(text, w, h) {
        const points = getFontPoints(text, 0, 0, w, h);
        w = w || points.width;
        h = h || points.height;
        super(w, h);
        this.m_points = [];
        loop(points.positions, (position) => {
            this.m_points.push(new Circle(5, "#f9c410").addTo(this).loc(position[0], position[1]));
        });
    }

    getPoints() {
        return this.m_points;
    }

    startEffect() {
        loop(this.m_points, point => {
            point.alp(.1);
        });
        this.m_index = 0;
        this.m_p = new Proportion(0, 100, 0, this.m_points.length - 1, null, true);
    }

    updateEffect(percent) {
        if (this.m_p && percent >= 0 && percent <= 100 ) {
            let index = this.m_p.convert(percent);
            for (let i = this.m_index; i < index; i ++) {
                animateAlpha(this.m_points[i], 1);
            }
            this.m_index = index;
        }
    }
}
